<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="style.css">
	<title>Marvel Comics</title>
	<script type="text/javascript">
		var xhr;

		function inici() {
			try {
				// Firefox, Opera 8.0+, Safari, Chrome
				xhr = new XMLHttpRequest();
			} catch (e) {
				// Internet Explorer
				try {
					xhr = new ActiveXObject("Msxml2.XMLHTTP");
					//ie6+
				} catch (e) {
					try {
						xhr = new ActiveXObject("Microsoft.XMLHTTP");
						//ie5
					} catch (e) {
						alert("El teu navegador no suporta AJAX!");
						return false;
					}
				}
			}
			document.getElementById("cercar").onkeyup = function () {
				ajaxFunction(this.value);
			};

			const vBody = document.querySelector('body');

			vBody.addEventListener('click', function(e) {
				if (e.target.classList.contains('divComic')) {
					// document.querySelector('.hidden').style.display = 'block';
					// console.log('Haz hecho clic en el div comics');
					const comicTitulo = e.target.querySelector('.comicTitulo').innerHTML;
					const comicImagen = e.target.querySelector('.imgComic').src;
					const comicDescripcion = e.target.querySelector('.comicDescripcion').innerHTML;
					const comicPersonatges = e.target.querySelector('.comicPersonatges').innerHTML;

					const hiddenDiv = document.querySelector('.hidden');
					hiddenDiv.style.display = 'block';

					hiddenDiv.innerHTML = `
						<h2 class="comicTituloSELECT">${comicTitulo}</h2>
						<img class="comicImgSELECT" src="${comicImagen}" alt="${comicTitulo}">
						<p class="comicDescripcionSELECT"><b>Descripció: </b>${comicDescripcion}</p>
						<p class="comicPersonatgesSELECT"><b>Personatges: </b>${comicPersonatges}</p>
						
					`;
				}else{
					document.querySelector('.hidden').style.display = 'none';
				}
			});
		}

		function ajaxFunction(cadena) {
			const marvel = {
				render: () => {
					var urlAPI = "https://gateway.marvel.com:443/v1/public/comics?titleStartsWith=" + cadena + "&apikey=476dc1b2d49f463c22c34cb1578bfdd0&hash=653580380735072c47d7edc8e4d8254a&ts=1";
					const container = document.querySelector('#comics');
					let contentHTML = '';
					// xhr.open("GET", url, true);
					fetch(urlAPI)
						.then(res => res.json())
						.then((json) => {
							for (const comic of json.data.results) {
							// console.log(comic);

							if (comic.thumbnail.path == "http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available") {
								comic.thumbnail.path = "public/imatges/marvelComics";
								comic.thumbnail.extension = "jpg";
							}
							
							// Llista dels personatges del comic
							var comicPersonatges = comic.characters.items;
							var llistaPersonatges = [];
							for (var i = 0; i < comicPersonatges.length; i++) {
								llistaPersonatges.push(comicPersonatges[i].name);
							}
							comic.characters = llistaPersonatges.join(", ");
							comic.characters = comic.characters ? comic.characters : "No s'ha trobat cap personatge.";
							
							// Descripció del comic
							var comicDescription = comic.description ? comic.description : "No s'ha trobat cap descripció.";

							// Portada del comic imatge + titol
							
							contentHTML += `
								<div class="divComic">
									<img class="imgComic" src="${comic.thumbnail.path}.${comic.thumbnail.extension}"  alt="${comic.title}">
									<div class="comicData">
									<p class="comicTitulo">${comic.title}</p>

									<p class="comicDescripcion">${comicDescription}</p>
									<p class="comicPersonatges">${comic.characters}</p>
									
									</div>
								</div>
							`;
							}
							container.innerHTML = contentHTML;
						})

					xhr.send();
				}
			};
			marvel.render();
		}
		// NECESAARIO AL FINAL
		window.addEventListener("load", inici, true);
	</script>
</head>

<body>
	<header>
		<nav>
		</nav>
		<input type="text" class="inCercar" name="cercar" id="cercar" placeholder="Cerca nom del comic...">
	</header>
	<div id="main">
		<div id="comics">
		</div>
	</div>
	<div class="hidden">
		awatafaka
	</div>
	<script src="index.js"></script>
</body>

</html>